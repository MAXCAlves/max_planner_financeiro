<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Max Planner Financeiro</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDKs - Autentica√ß√£o e Firestore -->
    <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore-compat.js"></script>
    
    <!-- Bibliotecas de Terceiros (PDF/Multil√≠ngue) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="exportar_pdf_relatorio.js"></script>
    <script src="suporte_multilingue.js"></script>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow p-4 flex justify-between items-center">
      <h1 class="text-xl font-bold text-blue-700" data-i18n="welcome">
        Max Planner Financeiro
      </h1>
      <div class="flex items-center gap-4">
        
        <!-- Bot√£o para o Painel Admin (COM ID E OCULTO POR PADR√ÉO) -->
        <button
          id="adminButton" 
          onclick="window.location.href='/painel_admin_max_planner.html'"
          class="text-blue-600 hover:underline text-sm hidden"
          data-i18n="adminPanel"
        >
          Painel Administrativo
        </button>

        <!-- Bot√£o para Tutoriais -->
        <button
          onclick="window.location.href='/pagina_tutoriais.html'"
          class="text-blue-600 hover:underline text-sm"
          data-i18n="tutorials"
        >
          Tutoriais
        </button>
        <!-- Bot√£o Sair -->
        <button
          id="logoutButton"
          onclick="logout()"
          class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 text-sm"
          data-i18n="logout"
        >
          Sair
        </button>
      </div>
    </header>

    <main class="max-w-7xl mx-auto p-6">
      <h2
        class="text-2xl font-semibold text-gray-800 mb-4"
        data-i18n="dashboard"
      >
        Painel de Controle
      </h2>

      <!-- √Årea de Feedback (Sucesso/Erro) -->
      <div id="feedbackMessage" class="hidden p-3 rounded-lg text-center mb-4"></div>
      <div id="loadingIndicator" class="hidden text-center text-blue-600 font-semibold mb-4">
        Processando sua planilha... Isso pode levar alguns segundos.
      </div>
      
      <!-- Indicadores Chave -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
        <!-- Receitas -->
        <div class="bg-white p-6 rounded shadow border-l-4 border-green-500">
          <h3 class="text-lg font-medium text-gray-500" data-i18n="totalIncome">
            Receitas
          </h3>
          <p id="totalIncome" class="text-2xl font-bold text-green-600">
            R$ 0,00
          </p>
        </div>

        <!-- Despesas -->
        <div class="bg-white p-6 rounded shadow border-l-4 border-red-500">
          <h3
            class="text-lg font-medium text-gray-500"
            data-i18n="totalExpenses"
          >
            Despesas
          </h3>
          <p id="totalExpenses" class="text-2xl font-bold text-red-600">
            R$ 0,00
          </p>
        </div>

        <!-- Saldo Investido -->
        <div class="bg-white p-6 rounded shadow border-l-4 border-yellow-500">
          <h3 class="text-lg font-medium text-gray-500" data-i18n="invested">
            Saldo Investido
          </h3>
          <p id="investedBalance" class="text-2xl font-bold text-yellow-600">
            R$ 0,00
          </p>
        </div>

        <!-- Saldo Dispon√≠vel -->
        <div class="bg-white p-6 rounded shadow border-l-4 border-blue-500">
          <h3
            class="text-lg font-medium text-gray-500"
            data-i18n="available"
          >
            Saldo Dispon√≠vel
          </h3>
          <p id="availableBalance" class="text-2xl font-bold text-blue-600">
            R$ 0,00
          </p>
        </div>
      </div>

      <!-- A√ß√µes e Relat√≥rios -->
      <div class="flex space-x-4 mb-10">
        <!-- Input de arquivo escondido -->
        <input type="file" id="excelFileInput" accept=".xlsx, .xls" class="hidden" />

        <!-- Bot√£o que dispara a abertura do seletor de arquivo -->
        <button
          onclick="document.getElementById('excelFileInput').click()"
          class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700"
          data-i18n="uploadExcel"
          id="uploadButton"
        >
          Enviar arquivo Excel
        </button>
        <!-- Chamada para a fun√ß√£o de exporta√ß√£o PDF -->
        <button
          onclick="gerarRelatorioPDF()"
          class="bg-yellow-500 text-white px-6 py-3 rounded-lg hover:bg-yellow-600"
          data-i18n="exportPDF"
        >
          Exportar Relat√≥rio em PDF
        </button>
      </div>

      <!-- Gr√°ficos -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Gr√°fico de Linha (Receitas x Despesas) -->
        <div class="lg:col-span-2 bg-white p-6 rounded shadow">
          <h3 class="text-xl font-semibold mb-4 text-gray-800">
            Evolu√ß√£o Mensal
          </h3>
          <canvas id="graficoLinha" style="max-height: 400px"></canvas>
        </div>

        <!-- Gr√°fico de Pizza (Distribui√ß√£o de Investimentos) -->
        <div class="lg:col-span-1 bg-white p-6 rounded shadow">
          <h3 class="text-xl font-semibold mb-4 text-gray-800">
            Distribui√ß√£o de Investimentos
          </h3>
          <canvas id="graficoPizza" style="max-height: 400px"></canvas>
        </div>
      </div>
    </main>

    <!-- Script de Integra√ß√£o e L√≥gica do Dashboard -->
    <script>
      // --- CONFIGURA√á√ÉO DO FIREBASE ---
      const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        // Adicione outras chaves se necess√°rio
      };
      
      // Endere√ßo da sua API Backend (Node.js/Express)
      const BACKEND_API_URL = "http://localhost:3000/api/upload-finance"; 
      
      // Inicializa o Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      // Vari√°veis de Estado Global
      let userFinancialData = null;
      let currentUserId = null; 
      let isAdmin = false; // Estado de permiss√£o administrativa

      const feedbackEl = document.getElementById('feedbackMessage');
      const loadingEl = document.getElementById('loadingIndicator');
      const adminButton = document.getElementById('adminButton'); // Bot√£o Admin

      // Fun√ß√£o auxiliar para exibir feedback
      function showFeedback(message, type = 'success') {
          feedbackEl.textContent = message;
          feedbackEl.className = 'p-3 rounded-lg text-center mb-4';
          if (type === 'success') {
              feedbackEl.classList.add('bg-green-100', 'text-green-800');
          } else if (type === 'error') {
              feedbackEl.classList.add('bg-red-100', 'text-red-800');
          }
          feedbackEl.classList.remove('hidden');
      }

      // --- 1. OUVINTE DE AUTENTICA√á√ÉO E BUSCA DE DADOS (COM CHECAGEM ADMIN) ---
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          currentUserId = user.uid;
          
          try {
            // Checagem de Custom Claims para permiss√£o Admin
            const token = await user.getIdTokenResult();
            isAdmin = token.claims.admin === true;
            
            // Exibe ou oculta o bot√£o Admin baseado na claim
            if (adminButton) {
                adminButton.classList.toggle('hidden', !isAdmin);
            }

            // Ouvinte em tempo real (onSnapshot) para dados financeiros
            db.collection("finances").doc(user.uid).onSnapshot(doc => {
                if (doc.exists) {
                    userFinancialData = doc.data();
                    console.log("Dados do usu√°rio atualizados em tempo real.");
                    renderDashboard(userFinancialData);
                } else {
                    console.warn("Nenhum dado financeiro encontrado. Inicializando dashboard vazio.");
                    renderDashboard({}); 
                }
            }, error => {
                console.error("Erro ao configurar onSnapshot:", error);
                showFeedback("Erro ao carregar dados em tempo real. Tente recarregar a p√°gina.", 'error');
            });

          } catch (error) {
            console.error("Erro no carregamento do Dashboard:", error);
            showFeedback("Erro ao carregar dados iniciais ou permiss√µes.", 'error');
          }
        } else {
          // Usu√°rio deslogado: Redirecionar para login
          window.location.href = "login.html";
        }
      });

      // --- 2. FUN√á√ÉO LOGOUT ---
      window.logout = function () {
        auth.signOut().then(() => {
          console.log("Usu√°rio desconectado.");
        }).catch((error) => {
          console.error("Erro ao sair:", error);
        });
      };
      
      // --- 3. IMPLEMENTA√á√ÉO DA CHAMADA √Ä API DE UPLOAD ---
      document.getElementById('excelFileInput').addEventListener('change', uploadExcelFile);

      async function uploadExcelFile(event) {
          const file = event.target.files[0];
          if (!file) return;

          loadingEl.classList.remove('hidden');
          feedbackEl.classList.add('hidden');

          try {
              // Obter ID Token para autenticar no Backend
              const idToken = await auth.currentUser.getIdToken();
              
              const formData = new FormData();
              formData.append('excel_file', file); 
              
              // Chamada √† API
              const response = await fetch(BACKEND_API_URL, {
                  method: 'POST',
                  headers: {
                      'Authorization': `Bearer ${idToken}` // Envia o token de autentica√ß√£o
                  },
                  body: formData // Envia o arquivo
              });

              loadingEl.classList.add('hidden');

              if (!response.ok) {
                  const errorData = await response.json();
                  throw new Error(errorData.error || "Erro desconhecido no processamento da planilha.");
              }

              // Sucesso
              const result = await response.json();
              showFeedback(`Sucesso! ${result.message}`, 'success');
              // O onSnapshot do Firebase far√° o dashboard recarregar automaticamente!

          } catch (error) {
              loadingEl.classList.add('hidden');
              console.error("Erro no upload da planilha:", error);
              showFeedback(`Falha no upload: ${error.message}`, 'error');
          } finally {
              event.target.value = null; 
          }
      }

      // --- 4. FUN√á√ÉO PRINCIPAL QUE RENDERIZA O DASHBOARD ---
      function renderDashboard(data) {
        
        // --- 4.1. TRATAMENTO DOS DADOS ---
        const receitasMensais = data.monthlyIncome || [0, 0, 0, 0, 0, 0];
        const despesasMensais = data.monthlyExpenses || [0, 0, 0, 0, 0, 0];
        const investimentoPorTipo = data.investmentDistribution || {}; 
        
        // C√ÅLCULOS
        const totalReceitas = receitasMensais.reduce((a, b) => a + b, 0);
        const totalDespesas = despesasMensais.reduce((a, b) => a + b, 0);
        const totalInvestido = investimentoPorTipo ? Object.values(investimentoPorTipo).reduce((a, b) => a + b, 0) : 0;
        const saldoDisponivel = totalReceitas - totalDespesas;

        const meses = data.meses || ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'].slice(0, receitasMensais.length);

        // --- 4.2. ATUALIZAR INDICADORES PRINCIPAIS (DOM) ---
        // Usa o formato brasileiro de moeda
        document.getElementById('totalIncome').textContent = `R$ ${totalReceitas.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        document.getElementById('totalExpenses').textContent = `R$ ${totalDespesas.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        document.getElementById('investedBalance').textContent = `R$ ${totalInvestido.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        document.getElementById('availableBalance').textContent = `R$ ${saldoDisponivel.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;

        // --- 4.3. RENDERIZAR GR√ÅFICO DE LINHA (Receitas x Despesas) ---
        const chartLinhaEl = document.getElementById('graficoLinha');
        if (Chart.getChart(chartLinhaEl)) Chart.getChart(chartLinhaEl).destroy();
        
        new Chart(chartLinhaEl, {
          type: 'line',
          data: {
            labels: meses,
            datasets: [
              { label: 'Receitas', data: receitasMensais, borderColor: '#10B981', fill: false },
              { label: 'Despesas', data: despesasMensais, borderColor: '#EF4444', fill: false },
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'top' },
              title: { display: true, text: 'Receitas x Despesas (mensal)' }
            }
          }
        });

        // --- 4.4. RENDERIZAR GR√ÅFICO DE PIZZA (Investimentos) ---
        const labelsPizza = Object.keys(investimentoPorTipo);
        const dataPizza = Object.values(investimentoPorTipo);
        
        const chartPizzaEl = document.getElementById('graficoPizza');
        if (Chart.getChart(chartPizzaEl)) Chart.getChart(chartPizzaEl).destroy();
        
        new Chart(chartPizzaEl, {
          type: 'pie',
          data: {
            labels: labelsPizza,
            datasets: [{
              data: dataPizza,
              backgroundColor: ['#3B82F6', '#8B5CF6', '#F59E0B', '#EC4899'] // Cores dos seus planos
            }]
          },
          options: {
            plugins: {
              title: {
                display: true,
                text: 'Distribui√ß√£o Atual'
              }
            }
          }
        });
        
        // Aplica as tradu√ß√µes
        applyTranslations(localStorage.getItem('lang') || 'pt-BR');
      }
    </script>
  </body>
</html>
```
eof

### üö® Lembrete Final sobre o Admin

O c√≥digo acima agora **verifica** se o usu√°rio √© administrador.

Para que voc√™ (o propriet√°rio da startup) possa ver o bot√£o "Painel Administrativo", voc√™ deve **rodar o script de Backend que define seu UID** como admin (usando o Firebase Admin SDK) pelo menos uma vez, conforme instru√≠do anteriormente:

```javascript
// Exemplo de como definir a sua pr√≥pria conta como admin no Backend:
// admin.auth().setCustomUserClaims("SEU_UID_REAL_DO_FIREBASE", {admin: true});
